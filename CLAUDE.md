# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a model serving infrastructure that provides secure, multi-user architecture for running vLLM with nginx reverse proxy, Open WebUI, and DNS services on a Tailscale network. The system uses rootless Podman containers with systemd quadlets for service management.

## Architecture

### Core Components
- **vLLM**: OpenAI-compatible LLM API server (port 8000)
- **Open WebUI**: ChatGPT-like web interface (port 3000)
- **Nginx**: Reverse proxy with SSL termination (ports 80, 443, 8081)
- **DNSmasq**: DNS server for `*.liminati.internal` domain (port 53, 5380)

### Security Model
- Each service runs as a dedicated unprivileged user
- Rootless containers via Podman
- No shared files between services
- SSL termination at nginx with self-signed certificates

### Directory Layout
```
/var/lib/
├── nginx-proxy/     (nginx-user)
├── dnsmasq-llm/     (dnsmasq-user)  
├── vllm/            (vllm-user)
└── webui/           (webui-user)
```

## Key Commands

### Installation & Setup
```bash
# Full installation (idempotent)
./scripts/install-quadlets.sh

# Client setup on remote machines
curl http://<tailscale-ip>:8081/install-client.sh | bash -s <tailscale-ip>
```

### Service Management
```bash
# Check service status (for any service: nginx-proxy, vllm-qwen, open-webui, dnsmasq)
sudo -u <service-user> XDG_RUNTIME_DIR=/run/user/$(id -u <service-user>) systemctl --user status <service-name>

# View logs
sudo -u <service-user> XDG_RUNTIME_DIR=/run/user/$(id -u <service-user>) journalctl --user -u <service-name> -f

# Restart service
sudo -u <service-user> XDG_RUNTIME_DIR=/run/user/$(id -u <service-user>) systemctl --user restart <service-name>

# vLLM-specific management
./scripts/vllm-manage.sh status|logs|restart|reconfigure
```

### Testing & Verification
```bash
# Test DNS resolution
nslookup webui.liminati.internal <tailscale-ip>

# Check vLLM health
curl http://localhost:8000/health

# Check nginx status
curl -k https://vllm.liminati.internal/health
```

## Important Files

### Scripts
- `scripts/install-quadlets.sh` - Main installer, creates users, directories, SSL certs, deploys quadlets
- `scripts/vllm-manage.sh` - vLLM/WebUI management utility
- `scripts/generate-ssl-cert.sh` - SSL certificate generation
- `scripts/install-client.sh` - Client-side setup script

### Quadlets (Systemd Service Definitions)
- `quadlets/vllm-qwen.container` - vLLM container configuration
- `quadlets/open-webui.container` - Open WebUI container configuration  
- `quadlets/nginx-proxy.container` - Nginx reverse proxy configuration
- `quadlets/dnsmasq.container` - DNSmasq DNS server configuration

### Configuration
- `config/nginx/nginx.conf` - Main nginx configuration
- `config/nginx/conf.d/*.conf` - Virtual host configurations
- `config/dnsmasq/dnsmasq.conf` - DNSmasq configuration

## Development Notes

### Adding New Services
1. Create a dedicated user for the service
2. Set up directory structure under `/var/lib/<service-name>/`
3. Create a quadlet file in `quadlets/`
4. Update nginx configuration if web-accessible
5. Deploy via `install-quadlets.sh`

### Modifying Existing Services
- Edit quadlet files in `quadlets/` directory
- Run `install-quadlets.sh` to deploy changes (idempotent)
- Use `systemctl --user daemon-reload` after quadlet changes

### SSL Certificates
- Wildcard cert for `*.liminati.internal`
- Generated by `generate-ssl-cert.sh`
- Stored in `/var/lib/nginx-proxy/ssl/`
- Private key permissions: 640, owned by nginx-user

### Debugging Services
- All services run as systemd user units
- Must use `sudo -u <user> XDG_RUNTIME_DIR=/run/user/$(id -u <user>)` prefix
- Check podman directly: `sudo -u <user> podman ps`
- Service logs in journalctl: `journalctl --unit=user@<uid>.service`

## Service Access Points
- Web UI: https://webui.liminati.internal
- vLLM API: https://vllm.liminati.internal
- DNS Admin: http://<tailscale-ip>:5380
- Client installer: http://<tailscale-ip>:8081/install-client.sh